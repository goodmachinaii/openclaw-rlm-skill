#!/bin/bash
# Pre-commit hook para prevenir leaks de secretos
# Instalar: cp scripts/pre-commit .git/hooks/ && chmod +x .git/hooks/pre-commit

set -e

echo "üîí Revisando posibles secretos en el commit..."

# Colores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Archivos a revisar (staged)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}‚úì No hay archivos staged${NC}"
    exit 0
fi

ERRORS=0

# 1. Revisar archivos de secretos comunes
for file in $STAGED_FILES; do
    # Detectar archivos .env reales (no .example)
    if echo "$file" | grep -qE '^\.env$|^\.env\.[^.]+$' && ! echo "$file" | grep -q '\.example$'; then
        echo -e "${RED}‚ùå ERROR: Intentas commitear un archivo de secrets: $file${NC}"
        echo "   Soluci√≥n: Agrega '$file' a .gitignore o usa .env.example como template"
        ERRORS=$((ERRORS + 1))
    fi
    
    # Detectar config/moonshot.env
    if [ "$file" = "config/moonshot.env" ]; then
        echo -e "${RED}‚ùå ERROR: Intentas commitear config/moonshot.env con posible API key${NC}"
        echo "   Soluci√≥n: Usa config/moonshot.env.example como template"
        ERRORS=$((ERRORS + 1))
    fi
    
    # Detectar archivos de claves
    if echo "$file" | grep -qE '\.(pem|key|p12|pfx)$'; then
        echo -e "${YELLOW}‚ö†Ô∏è  ADVERTENCIA: Posible archivo de clave privada: $file${NC}"
        echo "   Aseg√∫rate de que no deba ir en .gitignore"
    fi
done

# 2. Revisar contenido por patrones de API keys
if command -v grep >/dev/null 2>&1; then
    # Buscar patrones de API keys en contenido staged
    PATTERNS=(
        'sk-[a-zA-Z0-9]{20,}'              # OpenAI/Moonshot style keys
        'sk_live_[a-zA-Z0-9]{20,}'         # Stripe live keys
        'sk_test_[a-zA-Z0-9]{20,}'         # Stripe test keys
        'ghp_[a-zA-Z0-9]{36}'              # GitHub PAT
        'gho_[a-zA-Z0-9]{36}'              # GitHub OAuth
        'AKIA[0-9A-Z]{16}'                 # AWS Access Key
        '[0-9a-f]{32}'                     # Generic hex key (32 chars)
    )
    
    for pattern in "${PATTERNS[@]}"; do
        # Buscar en staged files, excluyendo archivos de ejemplo
        MATCHES=$(git diff --cached --no-ext-diff -U0 | grep -E "^\+" | grep -E "$pattern" || true)
        
        if [ -n "$MATCHES" ]; then
            echo -e "${RED}‚ùå ERROR: Posible API key detectada (patr√≥n: $pattern)${NC}"
            echo "$MATCHES" | head -3
            echo "   Soluci√≥n: Mueve la key a variables de entorno o GitHub Secrets"
            ERRORS=$((ERRORS + 1))
        fi
    done
fi

# Resultado
if [ $ERRORS -gt 0 ]; then
    echo ""
    echo -e "${RED}üö´ Commit bloqueado: $ERRORS problema(s) de seguridad encontrado(s)${NC}"
    echo ""
    echo "üí° Gu√≠a r√°pida:"
    echo "   1. API keys van en variables de entorno: export MOONSHOT_API_KEY='sk-...'"
    echo "   2. Usa archivos .example como templates"
    echo "   3. Para forzar el commit (NO RECOMENDADO): git commit --no-verify"
    echo ""
    exit 1
else
    echo -e "${GREEN}‚úì No se detectaron secretos${NC}"
    exit 0
fi
